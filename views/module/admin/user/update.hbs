<link rel="stylesheet" href="../css/style.css">
<script src="../js/connectAPI.js"></script>
<script src="../js/handle.js"></script>
<script src="../js/handleAdmin.js"></script>


<div class="container mt-3">
    <input type="hidden" id="getIdUserCreatedUpdated"
        value="{{body.user._id}}|{{ body.user.created_at }}|{{ body.user.updated_at }}">
    <div class="row">
        <div>
            <h1 class="text-info">CHỈNH SỬA TÀI KHOẢN</h1>
        </div>
        {{!-- <form method="post" enctype="multipart/form-data"> --}}
        <div>
            <div class="form-group">
                <label>Số điện thoại: {{body.user.note}}</label>
                <h3>{{body.user.phoneNumber}}</h3>
            </div>

            <div class="form-group">
                <label>Họ tên: </label>
                <input class="form-control" id="fullname" value="{{body.user.name}}">
            </div>

            <div class="form-group">
                <label>Địa chỉ: </label>
                <textarea class="form-control" rows="1" cols="50" id="address">{{body.user.address}}</textarea>
            </div>

            <div class="form-group">
                <label>Địa chỉ facebook: </label>
                <input class="form-control" id="facebook" value="{{body.user.facebook}}">
            </div>

            <div class="form-group">
                <label>Email: </label>
                <input class="form-control" id="email" value="{{body.user.email}}">
            </div>

            <div class="form-group">
                <label>Giới tính: </label>&nbsp
                <select id="genderId" class="btn btn-danger ml-2">
                    {{!-- <option value="" selected disabled hidden></option>
                    <option value="1">Nam</option>
                    <option value="0">Nữ</option>    --}}
                </select>
            </div>

            <div class="form-group">
                <label id="createdat"></label>
            </div>

            <div class="form-group">
                <label id="updatedat"></label>
            </div>

            <div class="form-group">
                <label>Trạng thái: </label>
                <select id="statusUser" class="btn btn-outline-primary ml-2">
                    <option value="1" {{#if body.user.status}} selected {{/if}}>Hoạt động</option>
                    <option value="0" {{#unless body.user.status}} selected {{/unless}}>Khóa</option>
                </select>
            </div>

            <div class="form-group">
                <label>Ghi chú: </label>
                <textarea class="form-control" rows="1" cols="50" id="note">{{body.user.note}}</textarea>
            </div>

            <div class="form-group">
                <label>Loại tài khoản: </label>
                <select id="permission" class="btn btn-outline-warning ml-3">
                    <option value="isUser" {{#if body.user.isUser}} selected {{/if}}>Người dùng</option>
                    <option value="isEmployee" {{#if body.user.isEmployee}} selected {{/if}}>Nhân viên</option>
                    <option value="isAdmin" {{#if body.user.isAdmin}} selected {{/if}}>Admin</option>
                </select>
            </div>

            <!-- Nút Xác nhận Lưu, Hủy -->
            <button type="submit" class="btn btn-success font-weight-bold" id="luu">Lưu</button>
            <button class="btn btn-outline-danger ml-3" id="huy">Hủy</button>
        </div>
        {{!-- </form> --}}
    </div>
</div>


<script>
    var gender = `{{body.user.gender}}`; 
    console.log(gender)
    if(gender == 'true')
        genderId.innerHTML = `<option value='1' selected >Nam</option> 
        <option value='0' >Nữ</option>`;
    else if(gender == 'false')
        genderId.innerHTML = `<option value='1'>Nam</option> 
        <option value='0' selected >Nữ</option>`;
    else if (gender == ``)
        genderId.innerHTML = `<option value='' selected disabled hidden>Chưa xác định</option> 
        <option value='1'>Nam</option> 
        <option value='0' >Nữ</option>`;
</script>



<script>
    TH_avatar.src = '../images/login_icon2.png';

    var arrayGet = getIdUserCreatedUpdated.value.split('|');
    var idUser = arrayGet[0];
    var createdAt = arrayGet[1];
    var updatedAt = arrayGet[2];

    createdat.innerHTML = 'Ngày tham gia: ' + getDateFormat(createdAt);
    updatedat.innerHTML = 'Chỉnh sửa gần đây nhất: ' + getDateFormat(updatedAt);

    huy.onclick = () => {
        window.location = Dia_chi_Dich_vu + '/admin/user';
    }

    luu.onclick = () => {
        var infoUserUpdate = [
            { "propName": "name", "value": fullname.value },
            { "propName": "address", "value": address.value },
            { "propName": "facebook", "value": facebook.value },
            { "propName": "email", "value": email.value },
            { "propName": "gender", "value": genderId.value == "" ? null : genderId.value},
            { "propName": "status", "value": statusUser.value },
            { "propName": "note", "value": note.value },
        ]
        if (permission.value == 'isAdmin') {
            infoUserUpdate.push({ "propName": "isAdmin", "value": true })
            infoUserUpdate.push({ "propName": "isEmployee", "value": false })
            infoUserUpdate.push({ "propName": "isUser", "value": false })
        }
        else if (permission.value == 'isEmployee') {
            infoUserUpdate.push({ "propName": "isAdmin", "value": false })
            infoUserUpdate.push({ "propName": "isEmployee", "value": true })
            infoUserUpdate.push({ "propName": "isUser", "value": false })
        }
        else if (permission.value == 'isUser') {
            infoUserUpdate.push({ "propName": "isAdmin", "value": false })
            infoUserUpdate.push({ "propName": "isEmployee", "value": false })
            infoUserUpdate.push({ "propName": "isUser", "value": true })
        }

        updateAccountUserAPI(sessionStorage.getItem('token'), idUser, infoUserUpdate)
            .then(result => {
                messageSuccess(result);
                setTimeout(() => {
                    window.location = Dia_chi_Dich_vu + '/admin/user';
                }, 1500);
            })
            .catch(err => {
                messageError(err);
            })
    }
</script>